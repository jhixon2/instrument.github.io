<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Processing with Canvas</title>
    <style>
        body { text-align: center; }
        canvas { border: 1px solid black; margin-top: 20px; }
        .button { padding: 10px 20px; font-size: 18px; cursor: pointer; margin-top: 20px; }
        .imgButton { background-color: #241649; color: white; }
        .imgButton:hover { background-color: #8e74d5; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.42/build/Tone.js"></script>
</head>
<body>

    <h1>Upload and Process an Image</h1>
    
    <button class="button imgButton" onclick="triggerImageUpload()">Upload Image</button>
    <input type="file" id="upload" style="display: none;" onchange="handleImageUpload(event)" accept="image/*">

    <canvas id="canvas"></canvas>
    <div id="shapesInfo" style="margin-top: 20px;"></div>

    <script>
        const osc = new Tone.Oscillator(440, "sine").toDestination();
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let imageData = null;
        let sounds = {};

        function triggerImageUpload() {
            document.getElementById('upload').click();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            let scaler = 128;

            const img = new Image();
            img.onload = function() {
                const ogHeight = img.height;
                const ogWidth = img.width;
                const aspectRatio = ogHeight/ ogWidth;
                const newHeight = Math.round(scaler * aspectRatio);
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = scaler;
                tempCanvas.height = newHeight;
                tempCtx.drawImage(img, 0, 0, scaler, newHeight);
                imageData = tempCtx.getImageData(0, 0, scaler, newHeight);
                let pixels = getPixels(imageData);
                for (let i = 0; i < scaler; i++) {
                    for (let j = 0; j < newHeight; j++){
                        let index = (j * scaler + i) * 4;
                        const [r, g, b, a] = pixels[j][i];
                        imageData.data[index] = r;
                        imageData.data[index + 1] = g;
                        imageData.data[index + 2] = b;
                        imageData.data[index + 3] = a;
                    }
                }
                canvas.width = ogWidth;
                canvas.height = ogHeight;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                tempCtx.putImageData(imageData, 0, 0);
                ctx.drawImage(tempCanvas, 0, 0, ogWidth, ogHeight);
                const shapes = getShapes(pixels);
                displayShapesInfo(shapes);
                const sounds = getSoundsByPixel(shapes);
                console.log(sounds);
                canvas.addEventListener('click', function(event) {
                    console.log("Click");
                    const canvasRect = canvas.getBoundingClientRect();
                    const x = Math.floor((event.clientX - canvasRect.left) / (canvas.width / imageData.width));
                    const y = Math.floor((event.clientY - canvasRect.top) / (canvas.height / imageData.height));
                    console.log(sounds);
                    console.log(x, y);
                    keyString = y + ',' + x;
                    const sound = sounds[keyString];
                    if (sound) {
                        playSound(sound);
                    }
                    else {
                        console.log("no sound at: ", keyString);
                        const soundTwo = sounds[y + 1 + ',' + x];
                        if (soundTwo) {
                            playSound(soundTwo);
                        }
                        else {
                            console.log("no sound2 at: ", x + 1, y);
                        }
                    }
                });
            };
            img.src = URL.createObjectURL(file);
        }

        function getPixels(imageData) {
            const pixels = [];
            const width = imageData.width;
            const height = imageData.height;
            let i = 0;
            let rounder = 128;
            
            for (let y = 0; y < height; y++) {
                const row = [];
                for (let x = 0; x < width; x++) {
                    const index = (y * width + x) * 4;
                    imageData.data[index] = Math.round(imageData.data[index] / rounder) * rounder;
                    imageData.data[index + 1] = Math.round(imageData.data[index + 1] / rounder) * rounder;
                    imageData.data[index + 2] = Math.round(imageData.data[index + 2] / rounder) * rounder;
                    const rgba = [
                    imageData.data[index],
                    imageData.data[index + 1],
                    imageData.data[index + 2],
                    imageData.data[index + 3]
                    ];
                    row.push(rgba);
                }
                pixels.push(row);
            }

            return pixels;
        }

        function getShapes(pixels) {
            const rows = pixels.length;
            const cols = pixels[0].length;
            let s = 0;
            const shapes = {};
            const neighbors = [];

            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    if (pixels[i][j][3] !== 0) {
                        const start = pixels[i][j];
                        shapes[s] = [[start[0], start[1], start[2], start[3]]];
                        shapes[s].push([i, j]);
                        let neighborCount = 0;

                        if (j < cols - 1 && pixels[i][j + 1][3] !== 0) {
                            neighbors.push([i, j + 1, pixels[i][j + 1]]);
                            neighborCount++;
                        }
                        if (i < rows - 1 && pixels[i + 1][j][3] !== 0) {
                            neighbors.push([i + 1, j, pixels[i + 1][j]]);
                            neighborCount++;
                        }

                        while (neighborCount > 0) {
                            const n = neighbors[neighborCount - 1];
                            const nPix = n[2];
                            pixels[n[0]][n[1]] = [nPix[0], nPix[1], nPix[2], 0];
                            neighbors.pop();
                            neighborCount--;

                            if (nPix[0] === start[0] && nPix[1] === start[1] && nPix[2] === start[2]) {
                                shapes[s].push([n[0], n[1]]);
                                neighborCount = addNeighbors(n, pixels, neighbors, rows, cols, neighborCount);
                            }
                        }
                        pixels[i][j][3] = 0;
                        s++;
                    }
                }
            }
            return shapes;
        }

        function addNeighbors(n, pixels, neighbors, rows, cols, neighborCount) {
            const [x, y] = [n[0], n[1]];

            const directions = [
                [-1, 0], [1, 0], [0, -1], [0, 1]
            ];

            for (const [dx, dy] of directions) {
                const nx = x + dx, ny = y + dy;
                if (nx >= 0 && nx < rows && ny >= 0 && ny < cols && pixels[nx][ny][3] !== 0) {
                    if (!neighbors.some(neighbor => neighbor[0] === nx && neighbor[1] === ny)) {
                        neighbors.push([nx, ny, pixels[nx][ny]]);
                        neighborCount++;
                    }
                }
            }
            
            return neighborCount;
        }

        function getSoundsByPixel(shapes) {
            const sounds = {}
            let maxSize = 1;
            Object.keys(shapes).forEach((key) => {
                let shapeSize = shapes[key].length;
                if (shapeSize > maxSize) {
                    maxSize = shapeSize;
                };
            });
            Object.keys(shapes).forEach((key) => {
                const size = shapes[key].length;
                const color = shapes[key][0];
                const luminance = (color[0] * 0.2126) + (color[1] * 0.7152) + (color[2] * 0.0722);
                const sound = getSound(maxSize, size, color, luminance);
                for (i = 1; i < size; i++) {
                    console.log(shapes[key][i]);
                    console.log("check");
                    keyString = shapes[key][i][0] + ',' + shapes[key][i][1];
                    sounds[keyString] = sound;
                }
            });

            return sounds;
        }

        function getSound(maxSize, size, color, luminance) {
            const volume = mapper(size, 1, maxSize, 50, 70);
            const frequency = mapper(luminance, 0, 255, 100, 750);
            const harmonics = [mapper(color[0], 0, 255, 0.1, 0.9), mapper(color[1], 0, 255, 0.1, 0.9), mapper(color[2], 0, 255, 0.1, 0.9)];
            return [volume, frequency, harmonics]
        }

        function mapper(val, x, y, a, b) {
            return a + (b - a) * (val - x) / (y - x);
        }

        function displayShapesInfo(shapes) {
            const shapesInfoDiv = document.getElementById('shapesInfo');
            shapesInfoDiv.innerHTML = '';

            const shapesList = document.createElement('ul');
            for (const shapeId in shapes) {
                const shape = shapes[shapeId];
                const listItem = document.createElement('li');
                listItem.textContent = `Shape ${shapeId}: Starting at [${shape[1]}] with color [${shape[0].slice(0, 3)}]`;
                shapesList.appendChild(listItem);
            }
            shapesInfoDiv.appendChild(shapesList);
        }

        function playSound(sound) {
            osc.frequency.value = sound[1];
            osc.type = 'custom';
            osc.partials = sound[2];
            osc.toDestination();
            osc.start();
            console.log(sound);
        }

    </script>

</body>
</html>

